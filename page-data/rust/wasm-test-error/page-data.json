{"componentChunkName":"component---src-templates-blog-post-js","path":"/rust/wasm-test-error/","result":{"data":{"site":{"siteMetadata":{"title":"あさくちブログ"}},"markdownRemark":{"id":"5ca4adbf-02e2-5985-98de-3b4d2f39295d","excerpt":"WSL2 環境で  がエラーになる。 libnss3.so がないとのことなので入れてみる。 全然わからないが、ググったところ chromium が入ってないのかも？？ 出力を紛失してしまったが以下のようなメッセージが出る・・・。 Please install it with:\nrequires the…","html":"<p>WSL2 環境で <code class=\"language-text\">wasm-pack test</code> がエラーになる。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ wasm-pack <span class=\"token builtin class-name\">test</span> --chrome --headless\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Checking <span class=\"token keyword\">for</span> the Wasm target<span class=\"token punctuation\">..</span>.\n    Finished dev <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Installing wasm-bindgen<span class=\"token punctuation\">..</span>.\n    Finished <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n     Running unittests <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/wasm_game_of_life-aae857f15fb3814c.wasm<span class=\"token punctuation\">)</span>\nno tests to run<span class=\"token operator\">!</span>\n     Running tests/web.rs <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/web-69bc5f1825b7858d.wasm<span class=\"token punctuation\">)</span>\nSet <span class=\"token function\">timeout</span> to <span class=\"token number\">20</span> seconds<span class=\"token punctuation\">..</span>.\ndriver status: <span class=\"token builtin class-name\">exit</span> status: <span class=\"token number\">127</span>\ndriver stderr:\n    /home/user1/.cache/.wasm-pack/chromedriver-526ccf0ba34cb949/chromedriver: error <span class=\"token keyword\">while</span> loading shared libraries: libnss3.so: cannot <span class=\"token function\">open</span> shared object file: No such <span class=\"token function\">file</span> or directory\n\nError: driver failed to <span class=\"token builtin class-name\">bind</span> port during startup\nerror: <span class=\"token builtin class-name\">test</span> failed, to rerun pass <span class=\"token string\">'--test web'</span>\nError: Running Wasm tests with wasm-bindgen-test failed\nCaused by: failed to execute <span class=\"token variable\"><span class=\"token variable\">`</span>cargo <span class=\"token builtin class-name\">test</span><span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">:</span> exited with <span class=\"token builtin class-name\">exit</span> status: <span class=\"token number\">1</span>\n  full command: <span class=\"token string\">\"cargo\"</span> <span class=\"token string\">\"test\"</span> <span class=\"token string\">\"--target\"</span> <span class=\"token string\">\"wasm32-unknown-unknown\"</span></code></pre></div>\n<p>libnss3.so がないとのことなので入れてみる。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libnss3</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ wasm-pack <span class=\"token builtin class-name\">test</span> --chrome --headless\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Checking <span class=\"token keyword\">for</span> the Wasm target<span class=\"token punctuation\">..</span>.\n    Finished dev <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Installing wasm-bindgen<span class=\"token punctuation\">..</span>.\n    Finished <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n     Running unittests <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/wasm_game_of_life-aae857f15fb3814c.wasm<span class=\"token punctuation\">)</span>\nno tests to run<span class=\"token operator\">!</span>\n     Running tests/web.rs <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/web-69bc5f1825b7858d.wasm<span class=\"token punctuation\">)</span>\nSet <span class=\"token function\">timeout</span> to <span class=\"token number\">20</span> seconds<span class=\"token punctuation\">..</span>.\nRunning headless tests <span class=\"token keyword\">in</span> Chrome on <span class=\"token variable\"><span class=\"token variable\">`</span>http://127.0.0.1:33971/<span class=\"token variable\">`</span></span>\nTry <span class=\"token function\">find</span> <span class=\"token variable\"><span class=\"token variable\">`</span>webdriver.json<span class=\"token variable\">`</span></span> <span class=\"token keyword\">for</span> configure browser<span class=\"token string\">'s capabilities:\nNot found\ndriver status: signal: 9\ndriver stdout:\n    Starting ChromeDriver 96.0.4664.45 (76e4c1bb2ab4671b8beba3444e61c0f17584b2fc-refs/branch-heads/4664@{#947}) on port 33971\n    Only local connections are allowed.\n    Please see https://chromedriver.chromium.org/security-considerations for suggestions on keeping ChromeDriver safe.\n    ChromeDriver was started successfully.\n\nError: non-200 response code: 404\n{\"value\":{\"error\":\"invalid session id\",\"message\":\"invalid session id\",\"stacktrace\":\"#0 0x55aa48159ee3 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#1 0x55aa47c2749f <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#2 0x55aa47c504ab <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#3 0x55aa47c7b1ec <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#4 0x55aa47c78f42 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#5 0x55aa47c78777 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#6 0x55aa47bfeff4 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#7 0x55aa47bffea0 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#8 0x55aa4818bbaa <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#9 0x55aa481a1651 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#10 0x55aa4818cb05 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#11 0x55aa481a2a68 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#12 0x55aa4818105f <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#13 0x55aa47bfeb6a <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>#14 0x7f02778480b3 <span class=\"token entity\" title=\"\\u003C\">\\u003C</span>unknown><span class=\"token entity\" title=\"\\n\">\\n</span>\"}}\nerror: test failed, to rerun pass '</span>--test web'\nError: Running Wasm tests with wasm-bindgen-test failed\nCaused by: failed to execute <span class=\"token variable\"><span class=\"token variable\">`</span>cargo <span class=\"token builtin class-name\">test</span><span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">:</span> exited with <span class=\"token builtin class-name\">exit</span> status: <span class=\"token number\">1</span>\n  full command: <span class=\"token string\">\"cargo\"</span> <span class=\"token string\">\"test\"</span> <span class=\"token string\">\"--target\"</span> <span class=\"token string\">\"wasm32-unknown-unknown\"</span></code></pre></div>\n<p>全然わからないが、ググったところ chromium が入ってないのかも？？</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span>  chromium-browser chromium-chromedriver</code></pre></div>\n<p>出力を紛失してしまったが以下のようなメッセージが出る・・・。</p>\n<blockquote>\n<p>Please install it with:\nrequires the chromium snap to be installed.</p>\n<p>snap install chromium</p>\n</blockquote>\n<p>言われるがまま、<code class=\"language-text\">snap install chromium</code>を打つもダメ・・・。</p>\n<p><a href=\"https://github.com/microsoft/WSL/issues/5126#issuecomment-653715201\">https://github.com/microsoft/WSL/issues/5126#issuecomment-653715201</a></p>\n<p>を参考に以下をインストール。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit<span class=\"token operator\">=</span>basic.target\n<span class=\"token builtin class-name\">exec</span> <span class=\"token function\">sudo</span> nsenter -t <span class=\"token variable\"><span class=\"token variable\">$(</span>pidof systemd<span class=\"token variable\">)</span></span> -a <span class=\"token function\">su</span> - <span class=\"token environment constant\">$LOGNAME</span>\nsnap version\n\n<span class=\"token function\">sudo</span> snap <span class=\"token function\">install</span> chromium</code></pre></div>\n<p>これで行けるようになったっぽい。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ wasm-pack <span class=\"token builtin class-name\">test</span> --chrome --headless\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Checking <span class=\"token keyword\">for</span> the Wasm target<span class=\"token punctuation\">..</span>.\n    Finished dev <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span>: Installing wasm-bindgen<span class=\"token punctuation\">..</span>.\n    Finished <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">[</span>unoptimized + debuginfo<span class=\"token punctuation\">]</span> target<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span>.01s\n     Running unittests <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/wasm_game_of_life-aae857f15fb3814c.wasm<span class=\"token punctuation\">)</span>\nno tests to run<span class=\"token operator\">!</span>\n     Running tests/web.rs <span class=\"token punctuation\">(</span>target/wasm32-unknown-unknown/debug/deps/web-69bc5f1825b7858d.wasm<span class=\"token punctuation\">)</span>\nSet <span class=\"token function\">timeout</span> to <span class=\"token number\">20</span> seconds<span class=\"token punctuation\">..</span>.\nRunning headless tests <span class=\"token keyword\">in</span> Chrome on <span class=\"token variable\"><span class=\"token variable\">`</span>http://127.0.0.1:35055/<span class=\"token variable\">`</span></span>\nTry <span class=\"token function\">find</span> <span class=\"token variable\"><span class=\"token variable\">`</span>webdriver.json<span class=\"token variable\">`</span></span> <span class=\"token keyword\">for</span> configure browser's capabilities:\nNot found\nrunning <span class=\"token number\">2</span> tests\n\n<span class=\"token builtin class-name\">test</span> web::test_tick <span class=\"token punctuation\">..</span>. ok\n<span class=\"token builtin class-name\">test</span> web::pass <span class=\"token punctuation\">..</span>. ok\n\n<span class=\"token builtin class-name\">test</span> result: ok. <span class=\"token number\">2</span> passed<span class=\"token punctuation\">;</span> <span class=\"token number\">0</span> failed<span class=\"token punctuation\">;</span> <span class=\"token number\">0</span> ignored</code></pre></div>\n<p>今後テスト実行の前には、以下を叩く必要あり。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">exec</span> <span class=\"token function\">sudo</span> nsenter -t <span class=\"token variable\"><span class=\"token variable\">$(</span>pidof systemd<span class=\"token variable\">)</span></span> -a <span class=\"token function\">su</span> - <span class=\"token environment constant\">$LOGNAME</span>\n$ wasm-pack <span class=\"token builtin class-name\">test</span> --chrome --headless</code></pre></div>","frontmatter":{"title":"wasm-pack test でエラー","date":"November 29, 2021","description":null}},"previous":{"fields":{"slug":"/rust/wasm/"},"frontmatter":{"title":"初めてのWebAssembly"}},"next":null},"pageContext":{"id":"5ca4adbf-02e2-5985-98de-3b4d2f39295d","previousPostId":"3642350e-32d0-5d6d-a71b-7e88ba09bfb9","nextPostId":null}},"staticQueryHashes":["2841359383","3348849317"]}