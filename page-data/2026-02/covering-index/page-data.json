{"componentChunkName":"component---src-templates-blog-post-js","path":"/2026-02/covering-index/","result":{"data":{"site":{"siteMetadata":{"title":"あさくちブログ"}},"markdownRemark":{"id":"2023aeb6-def5-5bea-aca3-e3006ac1e12c","excerpt":"概要 カバリングインデックス（Covering Index）の効果検証。\nインデックスに含まれるカラムだけでクエリの結果を返せる場合、テーブルデータそのものへのアクセス（ランダムI/O）を回避できるため、パフォーマンスが向上する。 https://dev.mysql.com/doc/refman/8.0/ja…","html":"<h2>概要</h2>\n<p>カバリングインデックス（Covering Index）の効果検証。\nインデックスに含まれるカラムだけでクエリの結果を返せる場合、テーブルデータそのものへのアクセス（ランダムI/O）を回避できるため、パフォーマンスが向上する。</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/ja/glossary.html#glos_covering_index\">https://dev.mysql.com/doc/refman/8.0/ja/glossary.html#glos_covering_index</a></p>\n<blockquote>\n<p>クエリーによって取得されたすべてのカラムを含むインデックス。 完全なテーブル行を見つけるためのポインタとしてインデックス値を使用する代わりに、クエリーはインデックス構造から値を返し、ディスク I/O を節約します。 InnoDB セカンダリインデックスには主キーカラムも含まれているため、InnoDB では、MyISAM で可能なより多くのインデックスにこの最適化手法を適用できます。</p>\n</blockquote>\n<p>実際にDockerでMySQLを立ち上げ、大量のレコードを投入して挙動と実行速度の差を確認した。</p>\n<h2>環境構築</h2>\n<p>データベースを作成</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -d \\\n    -p 3306:3306 \\\n    --name mysql-container-name \\\n    -v mysql-volume-name:/var/lib/mysql \\\n    -e MYSQL_ROOT_PASSWORD=password \\\n    mysql:8.4.8</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> my_db<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>テーブル定義とデータ投入</h2>\n<p>ちょっと良い例が思いつかなかったが、table_1 と table_2 の2つのテーブルをインデックスに含まれていない some_id で join を行う。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> table_1 <span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">BIGINT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n    category_id <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    some_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n    dummy_1 <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    dummy_2 <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    dummy_3 <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">INDEX</span> idx_category <span class=\"token punctuation\">(</span>category_id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> table_2 <span class=\"token punctuation\">(</span>\n    some_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n    branch_number <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n    some_text <span class=\"token keyword\">CHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>some_id<span class=\"token punctuation\">,</span> branch_number<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>ダミーデータを投入。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> cte_max_recursion_depth <span class=\"token operator\">=</span> <span class=\"token number\">100000001</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> table_1 <span class=\"token punctuation\">(</span>category_id<span class=\"token punctuation\">,</span> some_id<span class=\"token punctuation\">,</span> dummy_1<span class=\"token punctuation\">,</span> dummy_2<span class=\"token punctuation\">,</span> dummy_3<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">WITH</span> RECURSIVE seq <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> n\n    <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span>\n    <span class=\"token keyword\">SELECT</span> n <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">FROM</span> seq <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">100000000</span> <span class=\"token comment\">-- 1億回</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span>\n    FLOOR<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    FLOOR<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    MD5<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    MD5<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    MD5<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> seq<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> table_2 <span class=\"token punctuation\">(</span>some_id<span class=\"token punctuation\">,</span> branch_number<span class=\"token punctuation\">,</span> some_text<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span>\n    some_id<span class=\"token punctuation\">,</span>\n    ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">PARTITION</span> <span class=\"token keyword\">BY</span> some_id <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> some_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> branch_number<span class=\"token punctuation\">,</span>\n    MD5<span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">SELECT</span> some_id\n    <span class=\"token keyword\">FROM</span> table_1\n    <span class=\"token keyword\">WHERE</span> some_id <span class=\"token operator\">IS</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span>\n    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10000000</span> <span class=\"token comment\">-- 1千万件</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> random_source<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>カバリングインデックスでないインデックスでクエリを実行</h2>\n<p>まずはカバリングインデックスになっていない状態で検索。\n<code class=\"language-text\">category_id</code> にはインデックスがあるが、<code class=\"language-text\">some_id</code> はインデックスに含まれていない。</p>\n<p><strong>クエリ</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n  some_id\n<span class=\"token punctuation\">,</span> branch_number\n<span class=\"token punctuation\">,</span> some_text\n<span class=\"token keyword\">FROM</span>\n  table_1\n<span class=\"token keyword\">JOIN</span>\n  table_2\n<span class=\"token keyword\">USING</span>\n  <span class=\"token punctuation\">(</span>some_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">WHERE</span>\n  category_id <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\n<span class=\"token punctuation\">;</span></code></pre></div>\n<p>EXPLAIN結果</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># id, select_type, table, partitions, type, possible_keys, key, key_len, ref, rows, filtered, Extra\n'1', 'SIMPLE', 'table_1', NULL, 'ref', 'idx_category', 'idx_category', '4', 'const', '198784', '100.00', 'Using where'\n'1', 'SIMPLE', 'table_2', NULL, 'ref', 'PRIMARY', 'PRIMARY', '4', 'my_db.table_1.some_id', '65', '100.00', NULL</code></pre></div>\n<p><code class=\"language-text\">key</code> に <code class=\"language-text\">idx_category</code> が使われているが、<code class=\"language-text\">Extra</code> は <code class=\"language-text\">Using where</code> となっている。\nこれはインデックスで対象レコードを特定した後、<code class=\"language-text\">some_id</code> の値を取得するためにテーブル領域へアクセスしていることを意味する。</p>\n<p>実行時間\n0.090 sec</p>\n<h2>カバリングインデックスでクエリを実行</h2>\n<p>検索条件の <code class=\"language-text\">category_id</code> と、join 条件の <code class=\"language-text\">some_id</code> を含む複合インデックスに変更。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> table_1\n  <span class=\"token keyword\">DROP</span> <span class=\"token keyword\">INDEX</span> idx_category<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">INDEX</span> idx_category<span class=\"token punctuation\">(</span>category_id<span class=\"token punctuation\">,</span> some_id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span></code></pre></div>\n<p>同じクエリを実行。</p>\n<p>EXPLAIN結果</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># id, select_type, table, partitions, type, possible_keys, key, key_len, ref, rows, filtered, Extra\n'1', 'SIMPLE', 'table_1', NULL, 'ref', 'idx_category', 'idx_category', '4', 'const', '200576', '100.00', 'Using where; Using index'\n'1', 'SIMPLE', 'table_2', NULL, 'ref', 'PRIMARY', 'PRIMARY', '4', 'my_db.table_1.some_id', '63', '100.00', NULL</code></pre></div>\n<p><code class=\"language-text\">Extra</code> に <code class=\"language-text\">Using index</code> が表示された。\ntable_1についてはテーブル領域へのアクセスがスキップされインデックスの情報だけが使われている。</p>\n<p>実行時間\n0.00097 sec</p>\n<p>簡単な計測だがだいたい100倍程度高速になった。</p>\n<h1>参考</h1>\n<ul>\n<li><a href=\"https://dev.mysql.com/doc/refman/8.0/ja/glossary.html#glos_covering_index\">https://dev.mysql.com/doc/refman/8.0/ja/glossary.html#glos_covering_index</a></li>\n<li><a href=\"https://dev.mysql.com/doc/refman/8.0/ja/optimizing-innodb-queries.html\">https://dev.mysql.com/doc/refman/8.0/ja/optimizing-innodb-queries.html</a></li>\n</ul>","frontmatter":{"title":"MySQL カバリングインデックス","date":"February 16, 2026","description":null}},"previous":{"fields":{"slug":"/2026-02/useImperativeHandle/"},"frontmatter":{"title":"React useImperativeHandle を使う"}},"next":null},"pageContext":{"id":"2023aeb6-def5-5bea-aca3-e3006ac1e12c","previousPostId":"80cadd87-c9c7-5814-b716-41b7c9afec24","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}