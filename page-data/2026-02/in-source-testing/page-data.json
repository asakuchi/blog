{"componentChunkName":"component---src-templates-blog-post-js","path":"/2026-02/in-source-testing/","result":{"data":{"site":{"siteMetadata":{"title":"あさくちブログ"}},"markdownRemark":{"id":"70d7e27f-a602-5b21-b763-94528026e056","excerpt":"Vitest In-Source Testing インソーステスティングとは、プロダクトコードとテストコードが同じファイル内に入っているもの。\nプロダクトファイルとテストファイルを行ったり来たりしなくて便利です。\nテストのために export する必要がないのも good。 Vitest 導入 設定 vite…","html":"<h2>Vitest In-Source Testing</h2>\n<p>インソーステスティングとは、プロダクトコードとテストコードが同じファイル内に入っているもの。\nプロダクトファイルとテストファイルを行ったり来たりしなくて便利です。\nテストのために export する必要がないのも good。</p>\n<h2>Vitest 導入</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install -D vitest</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">// package.json\n{\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> \"scripts\": {\n<span class=\"token prefix unchanged\"> </span>   \"build\": \"react-router build\",\n<span class=\"token prefix unchanged\"> </span>   \"dev\": \"react-router dev\",\n<span class=\"token prefix unchanged\"> </span>   \"start\": \"react-router-serve ./build/server/index.js\",\n<span class=\"token prefix unchanged\"> </span>   \"typecheck\": \"react-router typegen &amp;&amp; tsc\",\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>   \"fix\": \"biome check --write .\"\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   \"fix\": \"biome check --write .\",\n<span class=\"token prefix inserted\">+</span>   \"test\": \"vitest\"\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> },\n</span>}</code></pre></div>\n<h2>設定</h2>\n<h3>vite.config.ts</h3>\n<p><code class=\"language-text\">test.includeSource</code> にソースファイルのパターンを指定する。\nまた、プロダクションビルド時にテストコードを削除するために <code class=\"language-text\">define</code> で <code class=\"language-text\">import.meta.vitest</code> を <code class=\"language-text\">undefined</code> に置換する設定を入れる。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> defineConfig <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"vite\"</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">defineConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  define<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"import.meta.vitest\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  test<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    includeSource<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"app/**/*.{js,ts}\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>tsconfig.json</h3>\n<p><code class=\"language-text\">import.meta.vitest</code> の型定義を認識させるために <code class=\"language-text\">types</code> を追加する。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"types\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"vitest/importMeta\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>実装例</h2>\n<p><code class=\"language-text\">if (import.meta.vitest)</code> ブロック内にテストが書ける。\nこの中はプロダクションビルド時に取り除かれるのでアプリに影響なし！</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// app/utils/sum.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">sum</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>a<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> b<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a <span class=\"token operator\">+</span> b\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>vitest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">,</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>vitest\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test sum\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>テスト実行</h2>\n<p>テストできてる！</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ npm test\n\n> test\n> vitest\n\n\n DEV  v4.0.18 /home/user1/work/repo/my-react-router-app\n\n ✓ app/utils/sum.ts (1 test) 1ms\n   ✓ add function adds two numbers 0ms\n\n Test Files  1 passed (1)\n      Tests  1 passed (1)\n   Start at  00:12:05\n   Duration  77ms (transform 6ms, setup 0ms, import 12ms, tests 1ms, environment 0ms)\n\n PASS  Waiting for file changes...\n       press h to show help, press q to quit</code></pre></div>\n<h2>ビルド結果の確認</h2>\n<p>ビルドする前にアプリに組み込みます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { sum } from \"~/utils/sum\";\n\nconst App = () => {\n  const x = sum(1, 2);\n\n  return &lt;div>hello {x}&lt;/div>;\n};\n\nexport default App;</code></pre></div>\n<p>ビルド時にはテストコードは削除されている。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// build/server/index.js の一部を抜粋\nconst route0 = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({\n  __proto__: null,\n  ErrorBoundary,\n  Layout,\n  default: root,\n  links\n}, Symbol.toStringTag, { value: \"Module\" }));\nconst sum = (a, b) => {\n  return a + b;\n};\nconst App2 = () => {\n  const x = sum(1, 2);\n  return /* @__PURE__ */ jsxs(\"div\", {\n    children: [\"hello \", x]\n  });\n};</code></pre></div>\n<h2>余談</h2>\n<p>Rust だとデフォルトでできるのでいいよね。</p>\n<h2>参考</h2>\n<p><a href=\"https://vitest.dev/guide/in-source.html\">https://vitest.dev/guide/in-source.html</a></p>","frontmatter":{"title":"Vitest でインソーステスティング","date":"2026/02/10","description":null,"tags":["React","Vitest"]}},"previous":{"fields":{"slug":"/2026-02/react-router-routing/"},"frontmatter":{"title":"React Router でファイルベースのルーティングに切り替える"}},"next":{"fields":{"slug":"/2026-02/browser-mode/"},"frontmatter":{"title":"Vitest の Browser Mode を導入"}}},"pageContext":{"id":"70d7e27f-a602-5b21-b763-94528026e056","previousPostId":"e54c339d-0986-5dde-a7f1-b91d46331fdd","nextPostId":"84f108b1-68c8-54fe-8b5e-998c19874daf"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}